name: Dependabot Auto Merge

on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: |
      (github.event_name == 'pull_request' && github.actor == 'dependabot[bot]') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request')

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install GitHub CLI
      run: |
        type -p curl >/dev/null || (apt update && apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && apt update \
        && apt install gh -y

    - name: Get PR number and SHA
      id: pr-info
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" == "workflow_run" ]; then
          # Get PRs associated with the workflow run
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/pulls --jq '.[0] | {number: .number, sha: .head.sha, user: .user.login}')
          if [ -n "$PR_DATA" ] && [ "$(echo $PR_DATA | jq -r '.user')" == "dependabot[bot]" ]; then
            echo "number=$(echo $PR_DATA | jq -r '.number')" >> $GITHUB_OUTPUT
            echo "sha=$(echo $PR_DATA | jq -r '.sha')" >> $GITHUB_OUTPUT
          else
            echo "Not a Dependabot PR, skipping..."
            exit 0
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Dependabot metadata
      id: metadata
      if: steps.pr-info.outputs.number != ''
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
        pr-number: ${{ steps.pr-info.outputs.number }}

    - name: Wait for CI to pass (on PR event)
      if: |
        github.event_name == 'pull_request' &&
        steps.metadata.outputs.update-type == 'version-update:semver-patch' &&
        steps.pr-info.outputs.number != ''
      uses: lewagon/wait-on-check-action@v1.3.4
      with:
        ref: ${{ steps.pr-info.outputs.sha }}
        check-name: 'test'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 30
        allowed-conclusions: success
        running-workflow-name: 'CI'

    - name: Verify CI passed (on workflow_run event)
      id: verify-ci
      if: |
        github.event_name == 'workflow_run' &&
        steps.metadata.outputs.update-type == 'version-update:semver-patch' &&
        steps.pr-info.outputs.number != ''
      env:
        PR_NUMBER_FROM_STEP: ${{ steps.pr-info.outputs.number }}
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "ci_passed=true" >> $GITHUB_OUTPUT
          echo "‚úì CI passed for PR #$PR_NUMBER_FROM_STEP"
        else
          echo "ci_passed=false" >> $GITHUB_OUTPUT
          echo "‚úó CI did not pass for PR #$PR_NUMBER_FROM_STEP"
          exit 1
        fi

    - name: Auto-merge for patch updates (after CI passes)
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' &&
        steps.pr-info.outputs.number != '' &&
        (github.event_name == 'pull_request' || steps.verify-ci.outputs.ci_passed == 'true')
      run: |
        PR_NUM="${{ steps.pr-info.outputs.number }}"
        echo "Auto-merging patch update PR #$PR_NUM after CI passed"
        gh pr merge "$PR_NUM" \
          --auto \
          --merge \
          --subject "Auto-merge: Dependabot patch update"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on minor/major updates
      if: |
        (steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
         steps.metadata.outputs.update-type == 'version-update:semver-major') &&
        steps.pr-info.outputs.number != ''
      run: |
        PR_NUM="${{ steps.pr-info.outputs.number }}"
        UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
        
        if [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
          MESSAGE="‚ö†Ô∏è This is a **minor** version update. Please review and manually approve this PR."
        else
          MESSAGE="üö® This is a **major** version update. Please carefully review and manually approve this PR."
        fi
        
        gh pr comment "$PR_NUM" --body "$MESSAGE"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}